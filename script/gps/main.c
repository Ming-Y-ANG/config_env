#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <time.h>
#include <signal.h>
#include <ih_serial.h>
#include <syslog.h>
#include <stdarg.h>
#include <sys/types.h>
#include <dirent.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <pthread.h>

void my_log(const char *format, ...);

#define LOG_DB my_log
#define MAX_FILES 50

int gl_exit = 0;
int frontend = 0;
int log_size = 20*1024*1024; //20M
int gl_serial_fd = -1;
char gl_tz[16] = {0};
    
struct ubx_cfg_poll {
	char *desc;
	unsigned char msg[24];
};

struct ubx_debug_messages {
	unsigned char msg[24];
};

typedef struct ubx_pro_msg{
    unsigned char sync_char[2];
    unsigned char class_id;
    unsigned char msg_id;
    unsigned short payload_len;
    unsigned char payload[0];
}ubx_pro_msg;

struct ubx_cfg_poll gl_ubx_m8_cfg_poll[] = {
	{"MON-VER", 0xB5, 0x62, 0x0A, 0x04, 0x00, 0x00, 0x0E, 0x34},
	{"CFG-ANT", 0xB5, 0x62, 0x06, 0x13, 0x00, 0x00, 0x19, 0x51},
	{"CFG-DAT", 0xB5, 0x62, 0x06, 0x06, 0x00, 0x00, 0x0C, 0x2A},
	{"CFG-DGNSS", 0xB5, 0x62, 0x06, 0x70, 0x00, 0x00, 0x76, 0x68},
	{"CFG-DOSC", 0xB5, 0x62, 0x06, 0x61, 0x00, 0x00, 0x67, 0x3B},
	{"CFG-EKF", 0xB5, 0x62, 0x06, 0x12, 0x00, 0x00, 0x18, 0x4E},
	{"CFG-ESFALG", 0xB5, 0x62, 0x06, 0x56, 0x00, 0x00, 0x5C, 0x1A},
	{"CFG-ESFGWT", 0xB5, 0x62, 0x06, 0x29, 0x00, 0x00, 0x2F, 0x93},
	{"CFG-ESRC", 0xB5, 0x62, 0x06, 0x60, 0x00, 0x00, 0x66, 0x38},
	{"CFG-FXN", 0xB5, 0x62, 0x06, 0x0E, 0x00, 0x00, 0x14, 0x42},
	{"CFG-GNSS", 0xB5, 0x62, 0x06, 0x3E, 0x00, 0x00, 0x44, 0xD2},
	{"CFG-HNR", 0xB5, 0x62, 0x06, 0x5C, 0x00, 0x00, 0x62, 0x2C},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x00, 0x09, 0x29},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x01, 0x0A, 0x2A},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x03, 0x0C, 0x2C},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x0C, 0x15, 0x35},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x0D, 0x16, 0x36},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x0E, 0x17, 0x37},
	{"CFG-INF", 0xB5, 0x62, 0x06, 0x02, 0x01, 0x00, 0x0F, 0x18, 0x38},
	{"CFG-ITFM", 0xB5, 0x62, 0x06, 0x39, 0x00, 0x00, 0x3F, 0xC3},
	{"CFG-LOGFILTER", 0xB5, 0x62, 0x06, 0x47, 0x00, 0x00, 0x4D, 0xED},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x05, 0x01, 0x0F, 0x3C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x05, 0x00, 0x0E, 0x3B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x30, 0x44, 0x77},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x32, 0x46, 0x79},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x50, 0x64, 0x97},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x33, 0x47, 0x7A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x31, 0x45, 0x78},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x02, 0x16, 0x49},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x01, 0x15, 0x48},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0B, 0x00, 0x14, 0x47},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x10, 0x14, 0x2D, 0x65},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x10, 0x04, 0x1D, 0x55},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x10, 0x15, 0x2E, 0x66},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x10, 0x02, 0x1B, 0x53},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x10, 0x03, 0x1C, 0x54},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x10, 0x10, 0x29, 0x61},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x28, 0x01, 0x32, 0x82},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x28, 0x02, 0x33, 0x83},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x28, 0x00, 0x31, 0x81},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x04, 0x04, 0x11, 0x3D},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x04, 0x00, 0x0D, 0x39},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x04, 0x02, 0x0F, 0x3B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x04, 0x03, 0x10, 0x3C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x04, 0x01, 0x0E, 0x3A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x21, 0x0E, 0x38, 0x81},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x21, 0x08, 0x32, 0x7B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x21, 0x0F, 0x39, 0x82},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x21, 0x0B, 0x35, 0x7E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x21, 0x0D, 0x37, 0x80},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x13, 0x60, 0x7C, 0xB7},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x13, 0x80, 0x9C, 0xD7},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x13, 0x21, 0x3D, 0x78},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x13, 0x10, 0x2C, 0x67},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x36, 0x49, 0x7B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x0B, 0x1E, 0x50},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x37, 0x4A, 0x7C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x09, 0x1C, 0x4E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x02, 0x15, 0x47},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x06, 0x19, 0x4B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x35, 0x48, 0x7A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x38, 0x4B, 0x7D},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x07, 0x1A, 0x4C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x21, 0x34, 0x66},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x2E, 0x41, 0x73},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x31, 0x44, 0x76},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x39, 0x4C, 0x7E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0A, 0x08, 0x1B, 0x4D},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x60, 0x6A, 0x93},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x05, 0x0F, 0x38},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x22, 0x2C, 0x55},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x36, 0x40, 0x69},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x31, 0x3B, 0x64},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x04, 0x0E, 0x37},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x3D, 0x47, 0x70},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x40, 0x4A, 0x73},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x61, 0x6B, 0x94},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x39, 0x43, 0x6C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x13, 0x1D, 0x46},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x14, 0x1E, 0x47},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x28, 0x32, 0x5B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x09, 0x13, 0x3C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x34, 0x3E, 0x67},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x62, 0x6C, 0x95},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x01, 0x0B, 0x34},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x02, 0x0C, 0x35},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x17, 0x21, 0x4A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x07, 0x11, 0x3A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x3C, 0x46, 0x6F},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x35, 0x3F, 0x68},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x32, 0x3C, 0x65},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x43, 0x4D, 0x76},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x42, 0x4C, 0x75},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x06, 0x10, 0x39},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x03, 0x0D, 0x36},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x30, 0x3A, 0x63},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x3B, 0x45, 0x6E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x24, 0x2E, 0x57},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x25, 0x2F, 0x58},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x23, 0x2D, 0x56},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x20, 0x2A, 0x53},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x26, 0x30, 0x59},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x63, 0x6D, 0x96},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x27, 0x31, 0x5A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x64, 0x6E, 0x97},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x21, 0x2B, 0x54},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x11, 0x1B, 0x44},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x01, 0x12, 0x1C, 0x45},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x22, 0x54, 0xA5},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x36, 0x68, 0xB9},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x04, 0x36, 0x87},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x3D, 0x6F, 0xC0},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x09, 0x3B, 0x8C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x01, 0x33, 0x84},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x02, 0x34, 0x85},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x17, 0x49, 0x9A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x07, 0x39, 0x8A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x35, 0x67, 0xB8},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x32, 0x64, 0xB5},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x43, 0x75, 0xC6},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x42, 0x74, 0xC5},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x03, 0x35, 0x86},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x3B, 0x6D, 0xBE},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x24, 0x56, 0xA7},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x25, 0x57, 0xA8},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x23, 0x55, 0xA6},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x20, 0x52, 0xA3},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x26, 0x58, 0xA9},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x63, 0x95, 0xE6},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x27, 0x59, 0xAA},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x21, 0x53, 0xA4},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x11, 0x43, 0x94},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x29, 0x12, 0x44, 0x95},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x30, 0x3B, 0x65},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x34, 0x3F, 0x69},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x31, 0x3C, 0x66},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x61, 0x6C, 0x96},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x14, 0x1F, 0x49},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x72, 0x7D, 0xA7},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x73, 0x7E, 0xA8},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x15, 0x20, 0x4A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x10, 0x1B, 0x45},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x59, 0x64, 0x8E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x32, 0x3D, 0x67},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x13, 0x1E, 0x48},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x11, 0x1C, 0x46},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x36, 0x41, 0x6B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x33, 0x3E, 0x68},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x20, 0x2B, 0x55},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x02, 0x74, 0x7F, 0xA9},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x27, 0x0A, 0x3A, 0x89},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x27, 0x10, 0x40, 0x8F},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x27, 0x09, 0x39, 0x88},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x27, 0x03, 0x33, 0x82},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x11, 0x27, 0x5C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x16, 0x2C, 0x61},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x13, 0x29, 0x5E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x04, 0x1A, 0x4F},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x03, 0x19, 0x4E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x12, 0x28, 0x5D},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x01, 0x17, 0x4C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x15, 0x2B, 0x60},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x0D, 0x06, 0x1C, 0x51},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0x09, 0x14, 0x26, 0x57},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x00, 0xF9, 0x11},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x01, 0xFA, 0x12},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x02, 0xFB, 0x13},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x03, 0xFC, 0x14},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x04, 0xFD, 0x15},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x05, 0xFE, 0x16},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x06, 0xFF, 0x17},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x07, 0x00, 0x18},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x08, 0x01, 0x19},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x09, 0x02, 0x1A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x0A, 0x03, 0x1B},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x0D, 0x06, 0x1E},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x0E, 0x07, 0x1F},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF0, 0x0F, 0x08, 0x20},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x00, 0x00, 0x1F},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x01, 0x01, 0x20},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x02, 0x02, 0x21},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x04, 0x04, 0x23},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x05, 0x05, 0x24},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x08, 0x08, 0x27},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF7, 0x0D, 0x0D, 0x2C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF1, 0x00, 0xFA, 0x13},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF1, 0x01, 0xFB, 0x14},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF1, 0x03, 0xFD, 0x16},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF1, 0x04, 0xFE, 0x17},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x05, 0x03, 0x20},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x4A, 0x48, 0x65},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x4D, 0x4B, 0x68},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x54, 0x52, 0x6F},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x57, 0x55, 0x72},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x5E, 0x5C, 0x79},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x61, 0x5F, 0x7C},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x7C, 0x7A, 0x97},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0x7F, 0x7D, 0x9A},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0xE6, 0xE4, 0x01},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0xFE, 0xFC, 0x19},
	{"CFG-MSG", 0xB5, 0x62, 0x06, 0x01, 0x02, 0x00, 0xF5, 0xFD, 0xFB, 0x18},
	{"CFG-NAV5", 0xB5, 0x62, 0x06, 0x24, 0x00, 0x00, 0x2A, 0x84},
	{"CFG-NAVX5", 0xB5, 0x62, 0x06, 0x23, 0x00, 0x00, 0x29, 0x81},
	{"CFG-NMEA", 0xB5, 0x62, 0x06, 0x17, 0x00, 0x00, 0x1D, 0x5D},
	{"CFG-ODO", 0xB5, 0x62, 0x06, 0x1E, 0x00, 0x00, 0x24, 0x72},
	{"CFG-PM", 0xB5, 0x62, 0x06, 0x32, 0x00, 0x00, 0x38, 0xAE},
	{"CFG-PM2", 0xB5, 0x62, 0x06, 0x3B, 0x00, 0x00, 0x41, 0xC9},
	{"CFG-PRT", 0xB5, 0x62, 0x06, 0x00, 0x01, 0x00, 0x00, 0x07, 0x21},
	{"CFG-PRT", 0xB5, 0x62, 0x06, 0x00, 0x01, 0x00, 0x01, 0x08, 0x22},
	{"CFG-PRT", 0xB5, 0x62, 0x06, 0x00, 0x01, 0x00, 0x02, 0x09, 0x23},
	{"CFG-PRT", 0xB5, 0x62, 0x06, 0x00, 0x01, 0x00, 0x03, 0x0A, 0x24},
	{"CFG-PRT", 0xB5, 0x62, 0x06, 0x00, 0x01, 0x00, 0x04, 0x0B, 0x25},
	{"CFG-RATE", 0xB5, 0x62, 0x06, 0x08, 0x00, 0x00, 0x0E, 0x30},
	{"CFG-RINV", 0xB5, 0x62, 0x06, 0x34, 0x00, 0x00, 0x3A, 0xB4},
	{"CFG-RXM", 0xB5, 0x62, 0x06, 0x11, 0x00, 0x00, 0x17, 0x4B},
	{"CFG-SBAS", 0xB5, 0x62, 0x06, 0x16, 0x00, 0x00, 0x1C, 0x5A},
	{"CFG-SMGR", 0xB5, 0x62, 0x06, 0x62, 0x00, 0x00, 0x68, 0x3E},
	{"CFG-TMODE", 0xB5, 0x62, 0x06, 0x1D, 0x00, 0x00, 0x23, 0x6F},
	{"CFG-TMODE2", 0xB5, 0x62, 0x06, 0x3D, 0x00, 0x00, 0x43, 0xCF},
	{"CFG-TMODE3", 0xB5, 0x62, 0x06, 0x71, 0x00, 0x00, 0x77, 0x6B},
	{"CFG-TP", 0xB5, 0x62, 0x06, 0x07, 0x00, 0x00, 0x0D, 0x2D},
	{"CFG-TP5", 0xB5, 0x62, 0x06, 0x31, 0x01, 0x00, 0x00, 0x38, 0xE5},
	{"CFG-TP5", 0xB5, 0x62, 0x06, 0x31, 0x01, 0x00, 0x01, 0x39, 0xE6},
	{"CFG-TXSLOT", 0xB5, 0x62, 0x06, 0x53, 0x00, 0x00, 0x59, 0x11},
	{"CFG-USB", 0xB5, 0x62, 0x06, 0x1B, 0x00, 0x00, 0x21, 0x69},
};

struct ubx_debug_messages gl_ubx_debug_message[] = {
	{0xB5, 0x62, 0x06, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x0C, 0xA4},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x49, 0x01, 0x60, 0xF6},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x41, 0x01, 0x58, 0xE6},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x1A, 0x01, 0x31, 0x98},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x4F, 0x01, 0x66, 0x02},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x4B, 0x01, 0x62, 0xFA},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x43, 0x01, 0x5A, 0xEA},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x31, 0x01, 0x48, 0xC6},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x56, 0x01, 0x6D, 0x10},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x21, 0x01, 0x38, 0xA6},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x10, 0x01, 0x27, 0x84},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x16, 0x01, 0x2D, 0x90},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x62, 0x01, 0x79, 0x28},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0C, 0x34, 0x01, 0x4B, 0xCC},
	{0xB5, 0x62, 0x0C, 0x35, 0x00, 0x00, 0x41, 0xCF},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x10, 0x02, 0x01, 0x1D, 0x74},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x10, 0x11, 0x01, 0x2C, 0x92},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x10, 0x10, 0x01, 0x2B, 0x90},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x10, 0x12, 0x01, 0x2D, 0x94},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0A, 0x36, 0x05, 0x4F, 0xCE},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0A, 0x06, 0x01, 0x1B, 0x6A},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0A, 0x1C, 0x01, 0x31, 0x96},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0A, 0x26, 0x01, 0x3B, 0xAA},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0A, 0x11, 0x01, 0x26, 0x80},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x0A, 0x02, 0x01, 0x17, 0x62},
	{0xB5, 0x62, 0x0A, 0x09, 0x00, 0x00, 0x13, 0x43},
	{0xB5, 0x62, 0x0A, 0x05, 0x00, 0x00, 0x0F, 0x37},
	{0xB5, 0x62, 0x0A, 0x04, 0x00, 0x00, 0x0E, 0x34},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x22, 0x01, 0x2E, 0x87},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x34, 0x01, 0x40, 0xAB},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x07, 0x01, 0x13, 0x51},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x3C, 0x01, 0x48, 0xBB},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x35, 0x01, 0x41, 0xAD},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x3B, 0x01, 0x47, 0xB9},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x60, 0x01, 0x6C, 0x03},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x30, 0x01, 0x3C, 0xA3},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x06, 0x01, 0x12, 0x4F},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x43, 0x01, 0x4F, 0xC9},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x02, 0x34, 0x01, 0x41, 0xAE},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x02, 0x20, 0x1E, 0x4A, 0xA3},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x02, 0x35, 0x01, 0x42, 0xB0},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x03, 0x10, 0x01, 0x1E, 0x69},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x03, 0x02, 0x01, 0x10, 0x4D},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x03, 0x0F, 0x01, 0x1D, 0x67},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x03, 0x0A, 0x01, 0x18, 0x5D},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x03, 0x09, 0x01, 0x17, 0x5B},
	{0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x08, 0x10, 0x01, 0x23, 0x78},

};


struct ubx_cfg_poll gl_ubx_m9_cfg_poll[] = {
	{"MON-VER", 0xB5, 0x62, 0x0A, 0x04, 0x00, 0x00, 0x0E, 0x34},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x0F, 0xA7, 0x9E}, 
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0xFF, 0x0F, 0xE7, 0x1E},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0xFF, 0x0F, 0x27, 0x9E},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x0F, 0x67, 0x1E},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xFF, 0x0F, 0xA8, 0xA3},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x40, 0x01, 0x00, 0x00, 0xFF, 0x0F, 0xE8, 0x23},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0xFF, 0x0F, 0x28, 0xA3},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0xC0, 0x01, 0x00, 0x00, 0xFF, 0x0F, 0x68, 0x23},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0xFF, 0x0F, 0xA9, 0xA8},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x40, 0x02, 0x00, 0x00, 0xFF, 0x0F, 0xE9, 0x28},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x80, 0x02, 0x00, 0x00, 0xFF, 0x0F, 0x29, 0xA8},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0xC0, 0x02, 0x00, 0x00, 0xFF, 0x0F, 0x69, 0x28},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0xFF, 0x0F, 0xAA, 0xAD},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x40, 0x03, 0x00, 0x00, 0xFF, 0x0F, 0xEA, 0x2D},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0xFF, 0x0F, 0x2A, 0xAD},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0xC0, 0x03, 0x00, 0x00, 0xFF, 0x0F, 0x6A, 0x2D},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0xFF, 0x0F, 0xAB, 0xB2},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x40, 0x04, 0x00, 0x00, 0xFF, 0x0F, 0xEB, 0x32},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x80, 0x04, 0x00, 0x00, 0xFF, 0x0F, 0x2B, 0xB2},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0xC0, 0x04, 0x00, 0x00, 0xFF, 0x0F, 0x6B, 0x32},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0xFF, 0x0F, 0xAC, 0xB7},
	{"CFG-VALGET", 0xB5, 0x62, 0x06, 0x8B, 0x08, 0x00, 0x00, 0x00, 0x40, 0x05, 0x00, 0x00, 0xFF, 0x0F, 0xEC, 0x37},
};

static int poll_ubx_data(int fd, void *msg, FILE *fp, int timeout)
{
#define UBX_SYNC_CHAR1 0xb5
#define UBX_SYNC_CHAR2 0x62

	struct timespec ts = {0};
	unsigned char buf[1024] = {0};
	unsigned int ts_ms = 0, ts_end_ms = 0;;
	int bytes_read = 0;
	fd_set read_fds;
	int select_result = -1;
	struct ubx_cfg_poll *poll = (struct ubx_cfg_poll *)msg;

	unsigned char  msg_class = poll->msg[2];
	unsigned char  msg_id = poll->msg[3];
	unsigned short msg_len = ((poll->msg[5] << 8) | poll->msg[4]) + 8;

	if(frontend){
		LOG_DB("Polling: %s - ", poll->desc);
		for(int i = 0; i < msg_len; i++){
			LOG_DB(" %02X", poll->msg[i]);
		}
		LOG_DB("\n");
	}

	if(write(fd, poll->msg, msg_len) != msg_len){
		LOG_DB("write data failed\n");
		return 0;
	}
	clock_gettime(CLOCK_MONOTONIC, &ts);
	ts_ms = ts.tv_sec * 1000 + ts.tv_nsec / 1000000;
	ts_end_ms = ts_ms + timeout;
	int done = 0;
	int msg_size = 0;
	int recv_size = 0;
	int write_size = 0;
	do{
		FD_ZERO(&read_fds);
		FD_SET(fd, &read_fds);
		struct timeval timeout = {.tv_sec = 0, .tv_usec = 100*1000};
		select_result = select(fd + 1, &read_fds, NULL, NULL, &timeout);
		if (select_result < 0) {
			if(errno != EINTR && errno != EAGAIN){
				LOG_DB("select error(%s)\n", strerror(errno));
				break;
			}
		} else if (select_result == 0) {
			if(frontend) LOG_DB("select timeout.\n");
		} else {
			if (FD_ISSET(fd, &read_fds)) {
				bytes_read = read(fd, buf, sizeof(buf) - 1);
				unsigned short offset = 0;
				while(bytes_read > 0){
					if(msg_size > 0){//read continue
						for(int i = 0; i < bytes_read && write_size < msg_size; i++){
							if(fp){
								fprintf(fp, " %02X", buf[i]);
								write_size++;
								offset++;
							}
						}
						bytes_read -= offset;
						if(write_size >= msg_size){
							done = 1;
							break;
						}
					}else {//find response
						if(buf[offset] == UBX_SYNC_CHAR1 && buf[offset + 1] == UBX_SYNC_CHAR2){
							ubx_pro_msg *rmsg = (ubx_pro_msg *)(buf + offset);
							if(rmsg->payload_len + 8 < (sizeof(buf) - offset)){
								if(rmsg->class_id == msg_class && rmsg->msg_id == msg_id){
									if(frontend) LOG_DB("... successfully completed!\n");
									if(fp){
										fprintf(fp, "%s -", poll->desc);
										msg_size = rmsg->payload_len + 4;
										recv_size = bytes_read - offset - 2;
										for(int i = 0; i < msg_size && i < recv_size; i++){
											fprintf(fp, " %02X", buf[offset + 2 + i]);
											write_size++;
										}
										offset += write_size + 2;
										bytes_read -= offset;

										if(write_size >= msg_size){
											done = 1;
										}
									}
									break;
								}else if(rmsg->class_id == 0x05 && rmsg->msg_id == 0x00){ //NAK
									if(frontend) LOG_DB("... message rejected!\n");
									done = 2;
									break;
								}
							}
						}
						offset++;
						bytes_read--;
					}
				}
			}
		}
		memset(buf, 0, sizeof(buf));
		clock_gettime(CLOCK_MONOTONIC, &ts);
		ts_ms = ts.tv_sec * 1000 + ts.tv_nsec / 1000000;
	}while(ts_ms < ts_end_ms && !done);

	if(done == 1 && fp){
		fprintf(fp, "\n");
	}

	return done;
}

static void dump_ubx_cfg(int fd, char *file, int modem)
{
	int timeout = 0;
	
	if(file){
		struct ubx_cfg_poll *cfg_poll = NULL;
		int poll_len = 0;
		if(modem == 9){
			cfg_poll = gl_ubx_m9_cfg_poll;
			poll_len = sizeof(gl_ubx_m9_cfg_poll)/sizeof(gl_ubx_m9_cfg_poll[0]);
			timeout = 400;
		}else{
			cfg_poll = gl_ubx_m8_cfg_poll;
			poll_len = sizeof(gl_ubx_m8_cfg_poll)/sizeof(gl_ubx_m8_cfg_poll[0]);
			timeout = 200;
		}

		FILE *fp = fopen(file, "w");
		if(fp){
			for(int i = 0; i < poll_len; i++){
				poll_ubx_data(fd, &cfg_poll[i], fp, timeout);
				if(gl_exit) break;
			}
			fclose(fp);
		}
	}
}

static void ubx_debug_message(int fd)
{
	for(int i = 0; i < sizeof(gl_ubx_debug_message)/sizeof(gl_ubx_debug_message[0]); i++){
		struct ubx_debug_messages *debug = &gl_ubx_debug_message[i];
		unsigned short msg_len = ((debug->msg[5] << 8) | debug->msg[4]) + 8;
		if(write(fd, debug->msg, msg_len) != msg_len){
			LOG_DB("write data failed(%s)\n", strerror(errno));
		}
		usleep(1000);
	}
}

static void get_log_filename(char *buf, int size, char *path, unsigned int *fsize, int new_file) 
{
    DIR *dir;
    struct dirent *entry;
    char filepath[128];
    struct stat st;
    time_t mtime = 0 ;
	int find = 0;
	time_t t = time(NULL);
	struct tm tm_now;
	char tmp_buf[128] = {0};
	char *suffix = NULL;

	if(new_file){
		goto leave;
	}

    dir = opendir(path);
    if (dir) {
		while ((entry = readdir(dir)) != NULL) {//find file size < 50M to append
			if (entry->d_name[0] == '.') continue;
			suffix = strrchr(entry->d_name, '.');
			if(suffix && strstr(suffix, ".ubx")){
				snprintf(filepath, sizeof(filepath), "%s/%s", path, entry->d_name);
				if (stat(filepath, &st) == 0 && S_ISREG(st.st_mode)) {
					if (st.st_mtime > mtime) {
						mtime = st.st_mtime;
						if(st.st_size < log_size){
							strncpy(buf, filepath, size);
							*fsize = st.st_size;
							find = 1;
							break;
						}
					}
				}
			}
		}
		closedir(dir);
    }

leave:
	if(!find){//new file
		localtime_r(&t, &tm_now);
		strftime(tmp_buf, sizeof(tmp_buf), "%y%m%d_%H%M%S.ubx", &tm_now);
		snprintf(buf, size, "%s/%s", path, tmp_buf);
		*fsize = 0;
	}
}

static int log_rotate(char *path, char *file)
{
    DIR *dir;
    struct dirent *entry;
    struct stat st;
    char filepath[128];
    int file_count = 0;
    char oldest_file[128] = {0};
    time_t oldest_time = time(NULL);
	char *suffix = NULL;

    dir = opendir(path);
    if (!dir) {
        return -1;
    }

    while ((entry = readdir(dir)) != NULL) {
        if (entry->d_name[0] == '.') continue;
		suffix = strrchr(entry->d_name, '.');
		if(suffix && strstr(suffix, ".gz")){
			snprintf(filepath, sizeof(filepath), "%s/%s", path, entry->d_name);
			if (stat(filepath, &st) == 0 && S_ISREG(st.st_mode)) {
				file_count++;
				if (st.st_mtime < oldest_time) {
					oldest_time = st.st_mtime;
					strncpy(oldest_file, filepath, sizeof(oldest_file));
				}
			}
		}
    }
    closedir(dir);

    if (file_count >= (MAX_FILES -1) && oldest_file[0]) {
        remove(oldest_file);
    }

	pid_t pid = fork();
	if(pid == 0){//gzip may take long time, use child do it
		execlp("gzip", "gzip", file, NULL);
		LOG_DB("gzip file failed\n");
        _exit(127);
	}

    return 0;
}

int read_gpio_value(int gpio_num) 
{
    char path[64];
    char value_str[3];
    int fd;

    snprintf(path, sizeof(path), "/sys/class/gpio/gpio%d/value", gpio_num);

    fd = open(path, O_RDONLY);
    if (fd < 0) {
        LOG_DB("open gpio value");
        return -1;
    }

    if (read(fd, value_str, sizeof(value_str)) < 0) {
        LOG_DB("read gpio value");
        close(fd);
        return -1;
    }

    close(fd);

    return atoi(value_str);
}

static void *ant_status_record(void *arg)
{
#define GPIO_GNSS_ANT_DETECT 50
#define GPIO_GNSS_ANT_SHORT 53

	int ant_detct = -1, ant_short = -1;
	int status;
	struct tm tm_now;
	time_t ts; 
	char tmp_buf[128] = {0};
	char *path = (char *)arg;
	unsigned int fsize = 0;
	int ret = 0;
    struct stat st;
	static int last_status = -1;

	snprintf(tmp_buf, sizeof(tmp_buf), "%s/ant.status", path);
	if(access(tmp_buf, F_OK) == 0){
		if(stat(tmp_buf, &st) == 0 && S_ISREG(st.st_mode)) {
			fsize = st.st_size;
			if(fsize > log_size){
				LOG_DB("ant.status file size > %uM, exit...\n", log_size/1024/1024);
				return NULL;
			}
		}
	}
	FILE *fp = fopen(tmp_buf, "a+");
	if(fp){
		LOG_DB("ant status recording...\n");
		setvbuf(fp, NULL, _IOLBF, 0);
		while(!gl_exit) {
			sleep(1);
			ant_detct = read_gpio_value(GPIO_GNSS_ANT_DETECT);
			ant_short = read_gpio_value(GPIO_GNSS_ANT_SHORT);
			status = ant_detct * 2 + ant_short;
			if(last_status == status){
				continue;
			}
			last_status = status;
			ts = time(NULL);
			localtime_r(&ts, &tm_now);
			strftime(tmp_buf, sizeof(tmp_buf), "[20%y-%m-%d %H:%M:%S]", &tm_now);
			switch (status){
				case 0:
					ret = fprintf(fp, "%s Antenna Open\n", tmp_buf);
					break;
				case 2:
					ret = fprintf(fp, "%s Antenna Normal\n", tmp_buf);
					break;
				case 3:
					ret = fprintf(fp, "%s Antenna Short\n", tmp_buf);
					break;
				default:
					ret = fprintf(fp, "%s Antenna Invalid\n", tmp_buf);
					break;
			}
			if(ret > 0){
				fsize += ret;
				if(fsize > log_size) break;
			}
		};
		fclose(fp);
		LOG_DB("ant recording exit...\n");
	}

	return NULL;
}

static void *gnss_log_record(void *arg)
{
	char buf[2048];
	int bytes_read;
	unsigned int fsize = 0;
	char file[128] = {0};
	FILE *fp = NULL;
	char *path = (char *)arg;
	if(path){
		get_log_filename(file, sizeof(file), path, &fsize, 0);
		fp = fopen(file, "a+");
		if(fp){
			LOG_DB("log recording...\n");
			do{
				bytes_read = read(gl_serial_fd, buf, sizeof(buf));
				if(bytes_read > 0){
					if(frontend){
						LOG_DB("bytes_read %u\n", bytes_read);
					}
					fwrite(buf, bytes_read, 1, fp);
					fsize += bytes_read;
					if(fsize > log_size){
						//LOG_DB("file size > %dMB, log_rotate...\n", log_size / 1024 / 1024);
						fclose(fp);
						fp = NULL;
						log_rotate(path, file);
						get_log_filename(file, sizeof(file), path, &fsize, 1);
						fp = fopen(file, "a+");
						if(!fp) {
							LOG_DB("get log file name failed\n");
							break;
						}
					}
				}
			}while(!gl_exit);

			if(fp) fclose(fp);
			LOG_DB("log recording exit...\n");
		}
	}

	return NULL;
}

static int tz_update(void)
{
	char sys_tz[16] = {0};
	char *tz_now = getenv("TZ");
	int ret;

    int fd = open("/etc/TZ", O_RDONLY);
    if (fd < 0) {
        LOG_DB("open /etc/TZ failed");
        return -1;
    }

	ret = read(fd, sys_tz, sizeof(sys_tz));
	if(ret > 0){
		while(ret > 0){
			if(sys_tz[ret] == '\r' || sys_tz[ret] == '\n'){
				sys_tz[ret] = '\0';
			}
			ret--;
		}
		if(strcmp(sys_tz, tz_now) != 0){
			snprintf(gl_tz, sizeof(gl_tz), "TZ=%s", sys_tz);
			putenv(gl_tz);
			//LOG_DB("change to -> %s(%d)\n", sys_tz, strlen(sys_tz));
			tzset();
		}
	}

	close(fd);

	LOG_DB("TZ -> %s\n", getenv("TZ"));

	return 0;
}

void sig_handler(int sig)
{
    if (sig == SIGTERM || sig == SIGINT) {
		LOG_DB("recv exit signal...\n");
		gl_exit = 1;
    }
}

void my_log(const char *format, ...)
{
    va_list args;
    char buffer[1024];

    va_start(args, format);
	if(!frontend){
		vsnprintf(buffer, sizeof(buffer), format, args);
		syslog(LOG_INFO, "%s", buffer);
	}else{
        vprintf(format, args);
        //fflush(stdout);
	}
    va_end(args);
}

void usage(char *name)
{
	printf(
			"Usage: %s [options]\n"
			"  -d <serial>          serial dev(default /dev/ttyXRUSB7)\n"
			"  -b <baudrate>        serial baudrate(default 115200)\n"
			"  -m <8|9>             8(m8), 9(m9)\n"
			"  -f                   front run\n"
			"  -s <log_size>        log file size(default 20M)\n"
			"  -p <log dir>         log dir(default /var/app/gnss)\n"
			, name);
}

// uart1 115200 ubx debug
// echo -ne '\xB5\x62\x06\x00\x14\x00\x01\x00\x00\x00\xD0\x08\x00\x00\x00\xC2\x01\x00\x07\x00\x03\x00\x00\x00\x00\x00\xC0\x7E' > /dev/ttyUSB0
// uart1 230400 ubx debug
// echo -ne '\xB5\x62\x06\x00\x14\x00\x01\x00\x00\x00\xD0\x08\x00\x00\x00\x84\x03\x00\x07\x00\x03\x00\x00\x00\x00\x00\x84\xE8' > /dev/ttyUSB0
int main(int argc, char **argv) 
{
	int c;
	char fpath[64] = "/var/app/gnss";
	char cfg_file[64] = {0};
	int baudrate = 115200;
	int modem = 8; //M8
	char dev[32] = "/dev/ttyXRUSB7";
	pthread_t tid_log = 0, tid_ant = 0;

	while ((c = getopt(argc, argv,  "d:b:hm:fs:p:")) != -1) {
		switch (c) {
			case 'h':
				usage(argv[0]);
				return 0;
			case 'd':
				snprintf(dev, sizeof(dev), "%s", optarg);
				break;
			case 'b':
				baudrate = atoi( optarg); 
				break;
			case 'm':
				modem = atoi( optarg); 
				break;
			case 'f':
				frontend = 1;
				break;
			case 's':
				log_size = atoi( optarg); 
				break;
			case 'p':
				snprintf(fpath, sizeof(fpath), "%s", optarg);
				break;
			default:
				printf( "ignore unknown arg: %c %s", c, optarg ? optarg : "");
				usage(argv[0]);
				exit(-1);
		}
	}

	openlog(argv[0], LOG_PID, LOG_DAEMON);
	tz_update();
	if(access(fpath, F_OK) != 0){
        LOG_DB("path(%s) not exist\n", fpath);
        return -1;
	}

	gl_serial_fd = ih_serial_init(dev, baudrate, 8, 1, 'N',  0, 0);
    if (gl_serial_fd < 0) {
        LOG_DB("modem(m%d) serial_init(%s) failed\n", modem, dev);
        return -1;
    }
    
    LOG_DB("init dev %s baudrate: %d modem: M%d\n", dev, baudrate, modem);
	signal(SIGTERM, sig_handler);
	signal(SIGINT, sig_handler);
	signal(SIGCHLD, SIG_IGN);
    
	//dump cfg
	snprintf(cfg_file, sizeof(cfg_file), "%s/ubx.cfg", fpath);
	LOG_DB("dump cfg -> %s\n", cfg_file);
	dump_ubx_cfg(gl_serial_fd, cfg_file, modem);
	//log record
	LOG_DB("dump log -> %s(file limit: size -> %dM, num -> %d)\n", fpath, log_size / 1024 / 1024, MAX_FILES);
	ubx_debug_message(gl_serial_fd);

	pthread_create(&tid_log, NULL, gnss_log_record, fpath);
	if(modem == 9){//M9
		pthread_create(&tid_ant, NULL, ant_status_record, fpath);
	}

	if(tid_log > 0){
		pthread_join(tid_log, NULL);
	}

	if(tid_ant > 0){
		pthread_join(tid_ant, NULL);
	}

	LOG_DB("all exit...\n");

	ih_serial_deinit(&gl_serial_fd);

	closelog();
			   
    return 0;
}

